<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .stat-label { color: #666; }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container { height: 300px; position: relative; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { text-align: center; padding: 20px; color: #dc2626; }
        .success { color: #16a34a; }
        .warning { color: #d97706; }
        h1, h2 { color: #1f2937; }
        .icon { font-size: 24px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Financial Dashboard</h1>
            <p>Real-time financial overview</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon" style="color: #16a34a;">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-label">Current Month Income</div>
                <div class="stat-value success" id="income">$0.00</div>
            </div>

            <div class="stat-card">
                <div class="icon" style="color: #dc2626;">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-label">Current Month Expenses</div>
                <div class="stat-value" id="expenses" style="color: #dc2626;">$0.00</div>
            </div>

            <div class="stat-card">
                <div class="icon" style="color: #2563eb;">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="stat-label">Net Profit</div>
                <div class="stat-value" id="net-profit">$0.00</div>
            </div>

            <div class="stat-card">
                <div class="icon" style="color: #7c3aed;">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="stat-label">Data Status</div>
                <div class="stat-value" id="status">
                    <span class="loading">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h2><i class="fas fa-chart-line"></i> Monthly Cash Flow</h2>
                <div class="chart-container">
                    <canvas id="cashFlowChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2><i class="fas fa-chart-pie"></i> Expense Breakdown</h2>
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Debug Info -->
        <div style="margin-top: 40px; padding: 20px; background: #f9fafb; border-radius: 8px;">
            <h3>Debug Information</h3>
            <div id="debug-info">Loading debug information...</div>
        </div>
    </div>

    <script>
        let cashFlowChart = null;
        let expenseChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded');
            updateDebugInfo('Dashboard loaded, initializing charts...');

            // Load chart data
            loadChartData();
        });

        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}<br>` + debugElement.innerHTML;
        }

        function loadChartData() {
            updateDebugInfo('Fetching data from API...');

            fetch('/api/dashboard-data/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateDebugInfo('✅ Data received successfully');
                    console.log('Dashboard data:', data);

                    updateStats(data);
                    createCharts(data);
                    updateStatus('success', 'Live Data');
                })
                .catch(error => {
                    updateDebugInfo(`❌ API Error: ${error.message}`);
                    console.error('API Error:', error);

                    // Use sample data as fallback
                    updateDebugInfo('⚠️ Using sample data as fallback');
                    const sampleData = getSampleData();
                    updateStats(sampleData);
                    createCharts(sampleData);
                    updateStatus('warning', 'Sample Data');
                });
        }

        function getSampleData() {
            return {
                'monthly_income': [5000.0, 5500.0, 5200.0, 5800.0, 6000.0, 6200.0],
                'monthly_expenses': [3200.0, 3500.0, 3300.0, 3800.0, 4000.0, 4200.0],
                'months': ['Jun 2024', 'Jul 2024', 'Aug 2024', 'Sep 2024', 'Oct 2024', 'Nov 2024'],
                'expense_categories': {
                    'labels': ['Food', 'Transport', 'Entertainment', 'Utilities', 'Healthcare'],
                    'values': [800.0, 400.0, 300.0, 500.0, 200.0],
                }
            };
        }

        function updateStats(data) {
            const currentMonthIncome = data.monthly_income[data.monthly_income.length - 1] || 0;
            const currentMonthExpenses = data.monthly_expenses[data.monthly_expenses.length - 1] || 0;
            const netProfit = currentMonthIncome - currentMonthExpenses;

            document.getElementById('income').textContent = `$${currentMonthIncome.toFixed(2)}`;
            document.getElementById('expenses').textContent = `$${currentMonthExpenses.toFixed(2)}`;
            document.getElementById('net-profit').textContent = `$${netProfit.toFixed(2)}`;

            // Update net profit color
            const netProfitElement = document.getElementById('net-profit');
            if (netProfit >= 0) {
                netProfitElement.style.color = '#16a34a';
            } else {
                netProfitElement.style.color = '#dc2626';
            }

            updateDebugInfo(`Stats updated: Income $${currentMonthIncome}, Expenses $${currentMonthExpenses}, Net Profit $${netProfit}`);
        }

        function updateStatus(type, message) {
            const statusElement = document.getElementById('status');
            const statusClass = type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'error';
            statusElement.innerHTML = `<span class="${statusClass}">${message}</span>`;
        }

        function createCharts(data) {
            updateDebugInfo('Creating charts...');

            try {
                // Destroy existing charts if they exist
                if (cashFlowChart) {
                    cashFlowChart.destroy();
                }
                if (expenseChart) {
                    expenseChart.destroy();
                }

                // Cash Flow Chart
                const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
                cashFlowChart = new Chart(cashFlowCtx, {
                    type: 'line',
                    data: {
                        labels: data.months,
                        datasets: [{
                            label: 'Income',
                            data: data.monthly_income,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.3,
                            fill: true
                        }, {
                            label: 'Expenses',
                            data: data.monthly_expenses,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: $${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });

                // Expense Chart
                const expenseCtx = document.getElementById('expenseChart').getContext('2d');
                expenseChart = new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: data.expense_categories.labels,
                        datasets: [{
                            data: data.expense_categories.values,
                            backgroundColor: [
                                'rgb(239, 68, 68)',
                                'rgb(59, 130, 246)',
                                'rgb(245, 158, 11)',
                                'rgb(34, 197, 94)',
                                'rgb(168, 85, 247)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: $${context.parsed.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                updateDebugInfo('✅ Charts created successfully');
            } catch (error) {
                updateDebugInfo(`❌ Chart creation error: ${error.message}`);
                console.error('Chart creation error:', error);
            }
        }

        // Refresh data every 30 seconds
        setInterval(loadChartData, 30000);
    </script>
</body>
</html>